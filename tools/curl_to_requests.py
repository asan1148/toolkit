import re
import json
from toolkit import re_search


def repl(mth):
   return mth.group().encode('utf-8').decode('unicode_escape')


def cur_to_requests(curl_cmd, filename):
    tmpl = """import requests


def main():
    url = "{}"
    headers = {}
    form = {}
    json = {}
    resp = requests.{}(url, headers=headers, json=json, data=form)
    print(resp.text)


main()
"""
    url = re.search(r"'(http.*?)'", curl_cmd).group(1)
    headers = json.dumps(
        dict(tuple(v.strip() for v in header.split(":", 1)) for header in re.findall(r"-H '(.*?)'", curl_cmd)), indent=4)
    form = re_search(r"--data ?'(.*?)'", curl_cmd, default=None)

    json_data = re_search(r"--data-binary \$'(.*?)'", curl_cmd, default=None)
    if form:
        form = json.dumps(dict(tuple(param.split("=", 1)) for param in form.replace("+", " ").split("&")), indent=4)
    if json_data:
        json_data = re.sub(r"\\u\w{4}", repl, json.dumps(json.loads(json_data), indent=4).replace("false", "False").replace("true", "True").replace("null", "None"))

    with open(filename, "w") as f:
        f.write(tmpl.format(
            url,
            headers,
            form,
            json_data,
            "post" if form or json_data else "get"))


cur_to_requests(
    """curl 'http://test.ddcdev.yiducloud.cn/api/pgcrf/crf/save?desease_id=pdsc_liver_injury_adr' -H 'Cookie: uid=fc19f383321a-54a9-9534-30e2-45f6863b; session=55ad75f2a38b160e3794aea7549038b9bb17bbdcd6c698a7989c898f28deba0b1ff828e460d387e0394006c26ecad116; sso_usession=55ad75f2a38b160e3794aea7549038b9bb17bbdcd6c698a7989c898f28deba0b1ff828e460d387e0394006c26ecad116; osession=9984c437245ed7a27f8473265c2a3550b2d38fd18123e84c731e43d73d43a834d2932041b97009ab08778c9ecec1c4359035f704997b3a683a93a950f653cf0ecc8c5bf2d81c5c39d562e47c8ff494fba06f895e9109105c91d5257bdca4ca1875d3ffce1cb59a5bf927cb1a9307a4fe1dea3b99bb4e9574a299ad7c7c2d57cad2d8919b7a0dc6a7e98fe1e3af169765144963fa10efb3d305fbd3fd6feb0b1f96abef334998af5e94bd1a78c7d8efa4adfba20968be0b744d24a86d473cf12d562bf45c67f4a49c11f5a957d452de4dad0000c119e0da5c84f1e468a91f0047716a65626d19730b0a1196f281fa9dda' -H 'Origin: http://test.ddcdev.yiducloud.cn' -H 'Accept-Encoding: gzip, deflate' -H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8' -H 'app-id: 2bbb7120-44cd-44ac-9c7f-1245e38d4d17' -H 'X-Requested-With: XMLHttpRequest' -H 'Connection: keep-alive' -H 'X-Request-Trace-ID: preview_2787d1a330c3a605687910bf8c6d2eaf' -H 'X-Appname: apollo' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36' -H 'Content-Type: application/json;charset=UTF-8' -H 'Accept: application/json, text/plain, */*' -H 'Referer: http://test.ddcdev.yiducloud.cn/ddc/index.html' -H 'domain-id: prdb' -H 'desease-id: pdsc_liver_injury_adr' --data-binary $'{"obj_type":"tpl","code":"1d8ba3d9aa56403e","description":"","name":"\u60a3\u8005\u57fa\u672c\u4fe1\u606f","c_time":"2018-05-03 10:50:24","section_list":[{"code":"61966537-9baf-4c87-a299-3f0bc2cc6b6b","name":"\u60a3\u8005\u4eba\u53e3\u5b66\u4fe1\u606f","ques_list":[{"lockSwitch":"","needOptBar":true,"editCheck":true,"checkMsg":"","showMsg":false,"users":[],"partner_name_list":[],"qid":260,"ques_type":"completion","item_info":{"note":"\u91c7\u7528\u533b\u6e21\u4e91\u552f\u4e00\u8bc6\u522b\u53f7","name":"unique_subject_id","data_type":"string","level":"","min_v":"","def_v":"","fcode":"76cc122938d6414b","item_type":"std","fversion":"","tag":"","max_v":"","unit":"","fid":763,"cn_name":"\u53d7\u8bd5\u8005\u552f\u4e00\u6807\u8bc6\u7b26","partner_ids":"","split_items":"","options":[],"disease_tags":"all"},"data_input_type":"manual_input","editDisabled":true,"show_detail":0,"id":"a9a550d512a34aa4b22063ea81bf3b54","unit":"","row":"","max_v":"","obj_type":"tpl","split_items":null,"dependency":null,"personal":false,"min_v":"","tip":"","detail":"","note":"\u91c7\u7528\u533b\u6e21\u4e91\u552f\u4e00\u8bc6\u522b\u53f7","u_time":"2018-04-21 16:07:52","fid":763,"status":"1","u_uid":1000,"tpl_id":"","data_type":"string","project_key":"sdv.l3.basic_info_unique_subject_id_2018050310533182363","fcode":"76cc122938d6414b","show_type":"","src_key":"crf.M001.S001.ADR_LIVER_INJURY.E002","purpose":"edit","edit_disabled":true,"partner_qid_list":[],"locked":false,"c_uid":1000,"column":"","show_name":"\u53d7\u8bd5\u8005\u552f\u4e00\u6807\u8bc6\u7b26","required":true,"def_v":"","item_type":"std","c_time":"2018-04-21 16:07:52","fname":"\u53d7\u8bd5\u8005\u552f\u4e00\u6807\u8bc6\u7b26","_id":260,"display":1,"custom_cat":""},{"lockSwitch":"","needOptBar":true,"editCheck":true,"checkMsg":"","showMsg":false,"users":[],"partner_name_list":[],"qid":262,"ques_type":"completion","item_info":{"note":"\u5c31\u8bca\u533b\u9662\u4e2d\u6587\u540d\u79f0\uff0c\u82e5\u4e3a\u591a\u5bb6\uff0c\u5219\u4e3alist","name":"study_site_name","data_type":"string","level":"","min_v":"","def_v":"","fcode":"53442d1fbdaa4278","item_type":"std","fversion":"","tag":"","max_v":"","unit":"","fid":765,"cn_name":"\u7814\u7a76\u4e2d\u5fc3","partner_ids":"","split_items":"","options":[],"disease_tags":"all"},"data_input_type":"manual_input","editDisabled":true,"show_detail":0,"id":"c4f5c83cb8f94c2dafac2734946093e2","unit":"","row":"","max_v":"","obj_type":"tpl","split_items":null,"dependency":null,"personal":false,"min_v":"","tip":"","detail":"","note":"\u5c31\u8bca\u533b\u9662\u4e2d\u6587\u540d\u79f0\uff0c\u82e5\u4e3a\u591a\u5bb6\uff0c\u5219\u4e3alist","u_time":"2018-04-21 16:07:52","fid":765,"status":"1","u_uid":1000,"tpl_id":"","data_type":"string","project_key":"sdv.l3.basic_info_study_site_name_2018050310533183038","fcode":"53442d1fbdaa4278","show_type":"","src_key":"crf.M001.S001.ADR_LIVER_INJURY.E004","purpose":"edit","edit_disabled":true,"partner_qid_list":[],"locked":false,"c_uid":1000,"column":"","show_name":"\u7814\u7a76\u4e2d\u5fc3","required":true,"def_v":"","item_type":"std","c_time":"2018-04-21 16:07:52","fname":"\u7814\u7a76\u4e2d\u5fc3","_id":262,"display":1,"custom_cat":""},{"lockSwitch":"","needOptBar":true,"editCheck":true,"checkMsg":"","showMsg":false,"users":[],"partner_name_list":[],"qid":261,"ques_type":"completion","item_info":{"note":"","name":"sex_cn","data_type":"string","level":"","min_v":"","def_v":"","fcode":"ed503917ac464b32","item_type":"std","fversion":"","tag":"","max_v":"","unit":"","fid":764,"cn_name":"\u6027\u522b-\u4e2d\u6587","partner_ids":"","split_items":"","options":[],"disease_tags":"all"},"data_input_type":"manual_input","editDisabled":true,"show_detail":0,"id":"4452422dabf245bfaea2f67a45bfd3b8","unit":"","row":"","max_v":"","obj_type":"tpl","split_items":null,"dependency":null,"personal":false,"min_v":"","tip":"","detail":"","note":"","u_time":"2018-04-21 16:07:52","fid":764,"status":"1","u_uid":1000,"tpl_id":"","data_type":"string","project_key":"sdv.l3.basic_info_sex_cn_2018050310533183992","fcode":"ed503917ac464b32","show_type":"","src_key":"crf.M001.S001.ADR_LIVER_INJURY.E005","purpose":"edit","edit_disabled":true,"partner_qid_list":[],"locked":false,"c_uid":1000,"column":"","show_name":"\u6027\u522b-\u4e2d\u6587","required":true,"def_v":"","item_type":"std","c_time":"2018-04-21 16:07:52","fname":"\u6027\u522b-\u4e2d\u6587","_id":261,"display":1,"custom_cat":""},{"lockSwitch":"","needOptBar":true,"editCheck":true,"checkMsg":"","showMsg":false,"users":[],"partner_name_list":[],"qid":161,"ques_type":"date","item_info":{"note":"\u60a3\u8005\u51fa\u751f\u65e5\u671f/\u65f6\u95f4\uff0c\u6309\u7167ISO8601\u683c\u5f0f\u6807\u51c6","name":"datetime_of_birth","data_type":"datetime","level":"","min_v":"","def_v":"","fcode":"7f80fd06abc3409c","item_type":"std","fversion":"","tag":"","max_v":"","unit":"","fid":757,"cn_name":"\u51fa\u751f\u65e5\u671f/\u65f6\u95f4","partner_ids":"","split_items":"","options":[],"disease_tags":"all"},"data_input_type":"manual_input","editDisabled":true,"show_detail":0,"id":"0784f8ab40614cc192c82819b493fcac","row":"","fcode":"7f80fd06abc3409c","obj_type":"tpl","item_type":"std","personal":false,"tip":"","detail":"","note":"\u60a3\u8005\u51fa\u751f\u65e5\u671f/\u65f6\u95f4\uff0c\u6309\u7167ISO8601\u683c\u5f0f\u6807\u51c6","u_time":"2018-04-21 16:07:52","fid":757,"status":"1","u_uid":1000,"tpl_id":"","data_type":"datetime","project_key":"sdv.l3.basic_info_datetime_of_birth_2018050310533184655","show_type":"","src_key":"crf.M001.S001.ADR_LIVER_INJURY.E009","purpose":"edit","edit_disabled":true,"date":"","partner_qid_list":[],"date_format":"%Y-%m-%d %H:%M:%S","locked":false,"c_uid":1000,"column":"","show_name":"\u51fa\u751f\u65e5\u671f/\u65f6\u95f4","required":true,"dependency":null,"c_time":"2018-04-21 16:07:52","fname":"\u51fa\u751f\u65e5\u671f/\u65f6\u95f4","_id":161,"display":1,"custom_cat":""},{"lockSwitch":"","needOptBar":true,"editCheck":true,"checkMsg":"","showMsg":false,"users":[],"partner_name_list":[],"qid":287,"ques_type":"completion","item_info":{"note":"","name":"medical_record_no_id","data_type":"string","level":"","min_v":"","def_v":"","fcode":"6b46b70843814a63","item_type":"std","fversion":"","tag":"","max_v":"","unit":"","fid":794,"cn_name":"\u75c5\u6848\u53f7\u7801","partner_ids":"","split_items":"","options":[],"disease_tags":"all"},"data_input_type":"manual_input","editDisabled":true,"show_detail":0,"id":"80511e89025e4e2ebcc65f904c39d449","unit":"","row":"","max_v":"","obj_type":"tpl","split_items":null,"dependency":null,"personal":false,"min_v":"","tip":"","detail":"","note":"","u_time":"2018-04-21 16:07:52","fid":794,"status":"1","u_uid":1000,"tpl_id":"","data_type":"string","project_key":"sdv.l3.basic_info_medical_record_no_id_2018050310533185313","fcode":"6b46b70843814a63","show_type":"","src_key":"crf.M001.S001.ADR_LIVER_INJURY.E010","purpose":"edit","edit_disabled":true,"partner_qid_list":[],"locked":false,"c_uid":1000,"column":"","show_name":"\u75c5\u6848\u53f7\u7801","required":true,"def_v":"","item_type":"std","c_time":"2018-04-21 16:07:52","fname":"\u75c5\u6848\u53f7\u7801","_id":287,"display":1,"custom_cat":""},{"lockSwitch":"","needOptBar":true,"editCheck":true,"checkMsg":"","showMsg":false,"users":[],"ques_type":"text","custom_cat":"text","id":"66eb19e02b4ca97ef1f51c9b0165c383","item_type":"custom","editDisabled":false,"ques_list":[],"fcode":"aab4038e55b58570f75d9c421dc707b3","fname":"\u591a\u884c\u6587\u672c\u6d4b\u8bd5","data_input_type":"manual_input","data_type":"string","project_key":"sdv.custom.\u591a\u884c\u6587\u672c\u6d4b\u8bd5_2018050310533185691","show_type":"","purpose":"edit","locked":false,"show_name":"\u591a\u884c\u6587\u672c\u6d4b\u8bd5","required":0,"dependency":{"rules":[],"enabled":0,"logic_operator":"and"},"display":1},{"lockSwitch":"","needOptBar":true,"editCheck":true,"checkMsg":"","showMsg":false,"users":[],"show_name":"\u5355\u9009\u9898\u6d4b\u8bd5","ques_type":"single_choice","data_type":"string","item_type":"custom","custom_cat":"single_choice","show_type":"select","required":0,"display":1,"dependency":{"rules":[],"logic_operator":"and","enabled":0},"fname":"\u5355\u9009\u9898\u6d4b\u8bd5","data_input_type":"manual_input","options":[{"show_name":"A","score":"","hide":0,"type":"project"},{"show_name":"B","score":"","hide":0,"type":"project"}],"show_detail":0,"ques_list":[],"purpose":"edit","id":"ca9b9f2599e6abd2b22678b88206ffe4","editDisabled":false,"locked":false,"fcode":"0a0e51aa361a66642153c194cae8a562"}],"id":"75c4c9e3-1e14-4bcd-8fc0-e59fb6988b31","display":1,"desc":""}],"is_basicinfo":true,"project_id":"f22c04c2-0159-4a6e-86d2-551c7503ea7a","crf_type":"init","u_uid":"b3686f54-2e03-4359-9a45-a123383f91cf","u_time":"2018-05-03 10:53:31","crf_id":117,"_id":117,"c_uid":"b3686f54-2e03-4359-9a45-a123383f91cf"}' --compressed""",
    "test.py")